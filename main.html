<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Valve Control System - Bluetooth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .connection-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .status-disconnected { background: #e74c3c; color: white; }
        .status-connected { background: #27ae60; color: white; }
        .status-connecting { background: #f39c12; color: white; }

        .troubleshooting {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .troubleshooting h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .troubleshooting ul {
            color: #856404;
            margin-left: 20px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .control-panel h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-connect { background: #3498db; color: white; }
        .btn-disconnect { background: #e74c3c; color: white; }
        .btn-process { background: #27ae60; color: white; }
        .btn-emergency { background: #c0392b; color: white; }
        .btn-test { background: #f39c12; color: white; }

        .valve-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .valve-button {
            aspect-ratio: 1;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background: #ecf0f1;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .valve-button:hover { transform: scale(1.05); }

        .valve-button.open {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .valve-button.closed {
            background: #95a5a6;
            color: white;
            border-color: #95a5a6;
        }

        .valve-light {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #7f8c8d;
            margin-bottom: 3px;
        }

        .valve-light.on {
            background: #f1c40f;
            box-shadow: 0 0 8px #f1c40f;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-display {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin-top: 15px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .log-panel {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 3px;
        }

        .log-timestamp { color: #888; }
        .log-error { color: #ff6b6b; }
        .log-success { color: #51cf66; }
        .log-info { color: #74c0fc; }
        .log-warning { color: #ffd43b; }

        .connection-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .method-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .method-card.active {
            border-color: #3498db;
            background: #ebf3fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Valve Control System</h1>
            <p>Bluetooth Wireless Control Interface</p>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status status-disconnected">
            ‚ùå Disconnected - Choose a connection method below
        </div>

        <!-- Troubleshooting Info -->
        <div class="troubleshooting" id="troubleshootingPanel">
            <h4>üîß Connection Troubleshooting:</h4>
            <ul>
                <li><strong>Web Bluetooth:</strong> Use Chrome/Edge browser only</li>
                <li><strong>HC-05 Module:</strong> Check if LED is blinking (discoverable mode)</li>
                <li><strong>Power:</strong> Verify HC-05 has 5V power and proper wiring</li>
                <li><strong>Phone Test:</strong> Try pairing HC-05 with your phone first</li>
                <li><strong>Arduino:</strong> Check Serial Monitor shows "ARDUINO_READY"</li>
            </ul>
        </div>

        <!-- Connection Methods -->
        <div class="connection-methods">
            <div class="method-card" id="webBluetoothCard">
                <h4>üì± Web Bluetooth (Chrome/Edge)</h4>
                <p>Direct browser connection</p>
                <button id="webBluetoothBtn" class="button btn-connect" onclick="connectWebBluetooth()">
                    Connect via Web Bluetooth
                </button>
                <div id="webBluetoothStatus">Ready</div>
            </div>

            <div class="method-card" id="serialCard">
                <h4>üîå Serial Simulation</h4>
                <p>Test interface without Bluetooth</p>
                <button class="button btn-test" onclick="enableSimulationMode()">
                    Enable Test Mode
                </button>
                <div id="serialStatus">Available</div>
            </div>

            <div class="method-card" id="websocketCard">
                <h4>üåê WiFi Bridge (Future)</h4>
                <p>ESP32 WiFi connection</p>
                <button class="button btn-connect" disabled>
                    Coming Soon
                </button>
                <div>ESP32 + HC-05 bridge</div>
            </div>
        </div>

        <!-- Main Controls Grid -->
        <div class="controls-grid">
            <!-- Process Control Panel -->
            <div class="control-panel">
                <h3>üîÑ Process Control</h3>
                <button class="button btn-process" onclick="startProcess(1)">üíß Affusion Process</button>
                <button class="button btn-process" onclick="startProcess(2)">üßΩ Cleaning Process</button>
                <button class="button btn-process" onclick="startProcess(3)">üîÑ Rinse Process</button>
                <button class="button btn-process" onclick="startProcess(4)">üìè Volume Test</button>
                <button class="button btn-emergency" onclick="emergencyStop()">üö® Emergency Stop</button>
            </div>

            <!-- System Status Panel -->
            <div class="control-panel">
                <h3>üìä System Status</h3>
                <div class="status-display">
                    <div class="status-row">
                        <span>Connection:</span>
                        <span id="connectionType">None</span>
                    </div>
                    <div class="status-row">
                        <span>Weight:</span>
                        <span id="currentWeight">0.00g</span>
                    </div>
                    <div class="status-row">
                        <span>Active Valves:</span>
                        <span id="activeValves">0</span>
                    </div>
                    <div class="status-row">
                        <span>System:</span>
                        <span id="systemStatus">Ready</span>
                    </div>
                </div>
                <button class="button btn-process" onclick="refreshStatus()">üîÑ Refresh Status</button>
                <button class="button btn-process" onclick="sendCommand('TARE_SCALE')">‚öñÔ∏è Tare Scale</button>
            </div>
        </div>

        <!-- Valve Control Grid -->
        <div class="control-panel">
            <h3>‚öôÔ∏è Manual Valve Control</h3>
            <button class="button btn-emergency" onclick="sendCommand('CLOSE_ALL')">üîí Close All Valves</button>
            
            <div class="valve-grid" id="valveGrid">
                <!-- Valves will be generated by JavaScript -->
            </div>
        </div>

        <!-- Communication Log -->
        <div class="log-panel" id="logPanel">
            <div class="log-entry"><span class="log-timestamp">[00:00:00]</span> <span class="log-info">System initialized. Choose connection method above.</span></div>
        </div>
    </div>

    <script>
        // Global variables
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;
        let isConnected = false;
        let connectionType = 'none';
        let valveStates = {};
        let simulationMode = false;

        // Check Web Bluetooth support
        function checkWebBluetoothSupport() {
            if (!navigator.bluetooth) {
                document.getElementById('webBluetoothBtn').disabled = true;
                document.getElementById('webBluetoothBtn').textContent = 'Not Supported';
                document.getElementById('webBluetoothStatus').textContent = 'Unsupported Browser';
                addLog('Web Bluetooth not supported in this browser', 'error');
                return false;
            }
            return true;
        }

        // Initialize valve grid
        function initializeValveGrid() {
            const valveGrid = document.getElementById('valveGrid');
            
            // Create valves 1-21
            for (let i = 1; i <= 21; i++) {
                createValveButton(i, valveGrid);
            }
            
            // Create AP valve
            createValveButton(99, valveGrid, true);
        }

        function createValveButton(valveNum, container, isAP = false) {
            const button = document.createElement('div');
            button.className = 'valve-button closed';
            button.id = `valve-${valveNum}`;
            button.onclick = () => toggleValve(valveNum);
            
            const light = document.createElement('div');
            light.className = 'valve-light';
            
            const label = document.createElement('div');
            label.textContent = isAP ? 'AP' : `V${valveNum.toString().padStart(2, '0')}`;
            
            const status = document.createElement('div');
            status.textContent = 'OFF';
            status.style.fontSize = '10px';
            
            button.appendChild(light);
            button.appendChild(label);
            button.appendChild(status);
            container.appendChild(button);
            
            valveStates[valveNum] = false;
        }

        // Web Bluetooth connection with multiple service attempts
        async function connectWebBluetooth() {
            if (!checkWebBluetoothSupport()) return;
            
            try {
                addLog('Searching for HC-05 Bluetooth device...', 'info');
                document.getElementById('webBluetoothStatus').textContent = 'Connecting...';
                
                // Try multiple filter options for HC-05
                const requestOptions = [
                    // Option 1: By name prefix
                    {
                        filters: [
                            { namePrefix: 'HC-05' },
                            { namePrefix: 'HC-06' },
                            { namePrefix: 'ValveControl' }
                        ],
                        optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
                    },
                    // Option 2: By service UUID
                    {
                        filters: [
                            { services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }
                        ]
                    },
                    // Option 3: Accept all devices (last resort)
                    {
                        acceptAllDevices: true,
                        optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
                    }
                ];

                let device = null;
                
                // Try each option
                for (let i = 0; i < requestOptions.length; i++) {
                    try {
                        addLog(`Trying connection method ${i + 1}...`, 'info');
                        device = await navigator.bluetooth.requestDevice(requestOptions[i]);
                        break;
                    } catch (error) {
                        addLog(`Method ${i + 1} failed: ${error.message}`, 'warning');
                        if (i === requestOptions.length - 1) throw error;
                    }
                }

                if (!device) throw new Error('No device selected');

                addLog(`Found device: ${device.name || 'Unknown'}`, 'success');
                addLog('Connecting to GATT server...', 'info');
                
                const server = await device.gatt.connect();
                
                addLog('Getting service...', 'info');
                const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                
                addLog('Getting characteristic...', 'info');
                bluetoothCharacteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
                
                // Set up notifications
                await bluetoothCharacteristic.startNotifications();
                bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);
                
                // Connection successful
                bluetoothDevice = device;
                isConnected = true;
                connectionType = 'bluetooth';
                
                updateConnectionStatus(true, device.name || 'HC-05');
                addLog('Bluetooth connected successfully!', 'success');
                
                // Request initial status
                setTimeout(() => sendCommand('GET_STATUS'), 1000);
                
            } catch (error) {
                addLog(`Bluetooth connection failed: ${error.message}`, 'error');
                document.getElementById('webBluetoothStatus').textContent = 'Failed';
                updateConnectionStatus(false);
                
                addLog('Try these solutions:', 'warning');
                addLog('1. Check HC-05 LED is blinking', 'warning');
                addLog('2. Verify Arduino code is running', 'warning');
                addLog('3. Try pairing with phone first', 'warning');
                addLog('4. Use Test Mode for debugging', 'warning');
            }
        }

        // Simulation mode for testing without Bluetooth
        function enableSimulationMode() {
            simulationMode = true;
            isConnected = true;
            connectionType = 'simulation';
            
            document.getElementById('serialCard').classList.add('active');
            updateConnectionStatus(true, 'Simulation Mode');
            addLog('Simulation mode enabled - UI will work without Arduino', 'success');
            
            // Simulate some data
            setTimeout(() => {
                updateWeight(125.40);
                updateValveState(1, true);
                updateValveState(5, true);
                updateValveState(12, true);
            }, 1000);
        }

        // Send command function
        async function sendCommand(command) {
            if (!isConnected) {
                addLog('Not connected to device', 'error');
                return;
            }
            
            if (simulationMode) {
                addLog(`[SIM] Sent: ${command}`, 'info');
                simulateResponse(command);
                return;
            }
            
            if (!bluetoothCharacteristic) {
                addLog('Bluetooth characteristic not available', 'error');
                return;
            }
            
            try {
                const encoder = new TextEncoder();
                await bluetoothCharacteristic.writeValue(encoder.encode(command + '\n'));
                addLog(`Sent: ${command}`, 'info');
            } catch (error) {
                addLog(`Send failed: ${error.message}`, 'error');
            }
        }

        // Simulate responses for test mode
        function simulateResponse(command) {
            setTimeout(() => {
                if (command === 'GET_STATUS') {
                    const status = {
                        weight: 125.40 + Math.random() * 10 - 5,
                        active_valves: Object.values(valveStates).filter(v => v).length,
                        system_running: false,
                        process: 0,
                        uptime: Date.now(),
                        valve_states: 42
                    };
                    handleSimulatedData('STATUS:' + JSON.stringify(status));
                } else if (command.startsWith('OPEN_')) {
                    const valve = parseInt(command.substring(5));
                    handleSimulatedData('VALVE_OPEN:' + valve);
                } else if (command.startsWith('CLOSE_')) {
                    const valve = parseInt(command.substring(6));
                    handleSimulatedData('VALVE_CLOSE:' + valve);
                } else if (command === 'CLOSE_ALL') {
                    handleSimulatedData('ALL_VALVES_CLOSED');
                }
            }, 200);
        }

        // Handle Bluetooth data
        function handleBluetoothData(event) {
            const decoder = new TextDecoder();
            const data = decoder.decode(event.target.value).trim();
            handleReceivedData(data);
        }

        // Handle simulated data
        function handleSimulatedData(data) {
            addLog(`[SIM] Received: ${data}`, 'success');
            handleReceivedData(data);
        }

        // Process received data (common for both real and simulated)
        function handleReceivedData(data) {
            if (data.startsWith('STATUS:')) {
                parseStatusData(data.substring(7));
            } else if (data.startsWith('VALVE_OPEN:')) {
                const valve = parseInt(data.substring(11));
                updateValveState(valve, true);
            } else if (data.startsWith('VALVE_CLOSE:')) {
                const valve = parseInt(data.substring(12));
                updateValveState(valve, false);
            } else if (data.startsWith('WEIGHT:')) {
                const weight = parseFloat(data.substring(7));
                updateWeight(weight);
            } else if (data === 'ALL_VALVES_CLOSED') {
                closeAllValvesUI();
            }
        }

        // Parse status data
        function parseStatusData(jsonStr) {
            try {
                const status = JSON.parse(jsonStr);
                updateWeight(status.weight);
                document.getElementById('activeValves').textContent = status.active_valves;
                document.getElementById('systemStatus').textContent = status.system_running ? 'Running' : 'Ready';
            } catch (error) {
                addLog(`Error parsing status: ${error.message}`, 'error');
            }
        }

        // UI Update functions
        function updateConnectionStatus(connected, deviceName = 'Unknown') {
            const statusElement = document.getElementById('connectionStatus');
            const connectionTypeElement = document.getElementById('connectionType');
            
            if (connected) {
                statusElement.className = 'connection-status status-connected';
                statusElement.textContent = `‚úÖ Connected via ${connectionType} - ${deviceName}`;
                connectionTypeElement.textContent = connectionType;
                document.getElementById('troubleshootingPanel').style.display = 'none';
            } else {
                statusElement.className = 'connection-status status-disconnected';
                statusElement.textContent = '‚ùå Disconnected - Choose connection method above';
                connectionTypeElement.textContent = 'None';
                document.getElementById('troubleshootingPanel').style.display = 'block';
            }
        }

        function updateValveState(valveNum, isOpen) {
            valveStates[valveNum] = isOpen;
            
            const button = document.getElementById(`valve-${valveNum}`);
            if (!button) return;
            
            const light = button.querySelector('.valve-light');
            const status = button.querySelector('div:last-child');
            
            if (isOpen) {
                button.className = 'valve-button open';
                light.className = 'valve-light on';
                status.textContent = 'ON';
            } else {
                button.className = 'valve-button closed';
                light.className = 'valve-light';
                status.textContent = 'OFF';
            }
        }

        function updateWeight(weight) {
            document.getElementById('currentWeight').textContent = `${weight.toFixed(2)}g`;
        }

        function closeAllValvesUI() {
            Object.keys(valveStates).forEach(valve => {
                updateValveState(parseInt(valve), false);
            });
        }

        // Control functions
        function startProcess(processNum) {
            sendCommand(`PROCESS_${processNum}`);
        }

        function emergencyStop() {
            sendCommand('EMERGENCY_STOP');
        }

        function toggleValve(valveNum) {
            const currentState = valveStates[valveNum];
            const command = currentState ? `CLOSE_${valveNum}` : `OPEN_${valveNum}`;
            sendCommand(command);
        }

        function refreshStatus() {
            sendCommand('GET_STATUS');
        }

        // Logging function
        function addLog(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span class="log-${type}">${message}</span>`;
            
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // Keep only last 100 entries
            while (logPanel.children.length > 100) {
                logPanel.removeChild(logPanel.firstChild);
            }
        }

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            initializeValveGrid();
            checkWebBluetoothSupport();
            addLog('Interface initialized. Choose a connection method above.', 'success');
        });
    </script>
</body>
</html>