<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dialyzer Valve Controller</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons (optional) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .terminal {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #0b0e14;
      color: #e6edf3;
      border-radius: .75rem;
      border: 1px solid rgba(255,255,255,.1);
      padding: .75rem;
      height: 360px;
      overflow: auto;
      white-space: pre-wrap;
    }
    .chip { border:1px solid rgba(255,255,255,.15); border-radius: 999px; padding:.25rem .6rem; }
    .card { border:1px solid rgba(255,255,255,.1); border-radius: 1rem; }
    .btn-wide { min-width: 150px; }
    .kbd { font-family: ui-monospace, monospace; background:#111; padding:.15rem .4rem; border-radius:.35rem; border:1px solid rgba(255,255,255,.12);}
    .muted { color: #9aa4b2; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg border-bottom">
  <div class="container">
    <span class="navbar-brand fw-semibold"><i class="bi bi-gear-wide-connected me-2"></i>HC‑05 Valve Controller</span>
    <div class="d-flex gap-2 align-items-center ms-auto">
      <span id="statusBadge" class="badge text-bg-secondary">Disconnected</span>
      <button id="btnConnect" class="btn btn-success btn-sm"><i class="bi bi-bluetooth"></i> Connect</button>
      <button id="btnDisconnect" class="btn btn-outline-danger btn-sm" disabled><i class="bi bi-x-circle"></i> Disconnect</button>
    </div>
  </div>
</nav>

<main class="container my-4">
  <!-- Connection settings -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-6 col-md-3">
          <label class="form-label">Baud rate</label>
          <select id="baud" class="form-select">
            <option value="9600" selected>9600 (HC‑05 default)</option>
            <option value="115200">115200 (Arduino USB)</option>
            <option value="38400">38400 (AT mode)</option>
            <option value="57600">57600</option>
            <option value="19200">19200</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Line ending</label>
          <select id="lineEnding" class="form-select">
            <option value="\n" selected>\n (LF)</option>
            <option value="\r\n">\r\n (CRLF)</option>
            <option value="">None</option>
          </select>
        </div>
        <div class="col-12 col-md-6">
          <div class="d-flex gap-2 flex-wrap">
            <span class="chip">Use Chrome/Edge desktop</span>
            <span class="chip">Serve via <span class="kbd">http://localhost</span></span>
            <span class="chip">Close Serial Monitor first</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick actions -->
  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold"><i class="bi bi-lightning-charge me-2"></i>Quick Actions</div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-6 col-md-4"><button class="btn btn-primary w-100" data-cmd="1">1 • Affusion</button></div>
            <div class="col-6 col-md-4"><button class="btn btn-primary w-100" data-cmd="2">2 • Cleaning</button></div>
            <div class="col-6 col-md-4"><button class="btn btn-primary w-100" data-cmd="3">3 • Rinse</button></div>
            <div class="col-6 col-md-4"><button class="btn btn-primary w-100" data-cmd="4">4 • Volume Test</button></div>
            <div class="col-6 col-md-4"><button class="btn btn-outline-primary w-100" data-cmd="6">Status (6)</button></div>
            <div class="col-6 col-md-4"><button class="btn btn-outline-warning w-100" data-cmd="7">Stop / Close All (7)</button></div>
            <div class="col-6 col-md-4"><button class="btn btn-outline-secondary w-100" data-cmd="status">status</button></div>
            <div class="col-6 col-md-4"><button class="btn btn-outline-secondary w-100" data-cmd="closeall">closeall</button></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Valve controls -->
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold"><i class="bi bi-valve me-2"></i>Valve Controls</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-sm-6">
              <label class="form-label">Valve number</label>
              <input type="number" id="valveNum" class="form-control" placeholder="1..21 or 99 (AP)" min="1" max="99">
            </div>
            <div class="col-12 col-sm-6 d-grid gap-2">
              <button id="btnOpen" class="btn btn-success"><i class="bi bi-toggle-on"></i> Open</button>
              <button id="btnClose" class="btn btn-danger"><i class="bi bi-toggle-off"></i> Close</button>
            </div>
            <div class="col-12 d-grid">
              <button id="btnAP" class="btn btn-outline-info btn-wide"><i class="bi bi-wrench-adjustable-circle"></i> AP Valve (99): Open / Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom command + Log -->
    <div class="col-12">
      <div class="card">
        <div class="card-header fw-semibold"><i class="bi bi-terminal me-2"></i>Console</div>
        <div class="card-body">
          <div class="row g-3 align-items-end mb-2">
            <div class="col-12 col-md-9">
              <label class="form-label">Custom command</label>
              <input id="cmd" class="form-control" placeholder='e.g. "open 6", "AFFUSION", "status"'>
            </div>
            <div class="col-12 col-md-3 d-grid">
              <button id="btnSend" class="btn btn-secondary"><i class="bi bi-send"></i> Send</button>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="muted">Log (device output + your commands)</div>
            <div class="d-flex gap-2">
              <button id="btnClear" class="btn btn-outline-light btn-sm"><i class="bi bi-trash"></i> Clear</button>
              <button id="btnCopy" class="btn btn-outline-light btn-sm"><i class="bi bi-clipboard"></i> Copy</button>
              <button id="btnDownload" class="btn btn-outline-light btn-sm"><i class="bi bi-download"></i> Download</button>
            </div>
          </div>
          <div id="log" class="terminal"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help -->
  <div class="mt-4 small muted">
    <i class="bi bi-info-circle"></i> Tips: Pair HC‑05 in your OS first. For HC‑05 pick <span class="kbd">9600</span>. For Arduino USB pick <span class="kbd">115200</span>. Your Arduino code should read line‑ended commands (we send <span class="kbd">\n</span> by default).
  </div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* === Web Serial controller (HC-05 / Arduino) === */

let port = null;
let reader = null;
let writer = null;
let reading = false;
let logBuffer = "";

const el = id => document.getElementById(id);
const statusBadge = el('statusBadge');
const btnConnect = el('btnConnect');
const btnDisconnect = el('btnDisconnect');
const baudSel = el('baud');
const lineSel = el('lineEnding');
const logBox = el('log');

function setConnectedUI(connected) {
  statusBadge.className = 'badge ' + (connected ? 'text-bg-success' : 'text-bg-secondary');
  statusBadge.textContent = connected ? 'Connected' : 'Disconnected';
  btnConnect.disabled = connected;
  btnDisconnect.disabled = !connected;
  document.querySelectorAll('button[data-cmd], #btnOpen, #btnClose, #btnAP, #btnSend')
    .forEach(b => b.disabled = !connected);
}

function ts() {
  const d = new Date();
  return d.toLocaleTimeString();
}

function log(msg, dir = '→') {
  const line = `[${ts()}] ${dir} ${msg}\n`;
  logBuffer += line;
  logBox.textContent += line;
  // Keep the last ~10k chars to avoid runaway memory
  if (logBuffer.length > 10000) {
    logBuffer = logBuffer.slice(logBuffer.length - 10000);
    logBox.textContent = logBuffer;
  }
  logBox.scrollTop = logBox.scrollHeight;
}

async function connect() {
  try {
    if (!('serial' in navigator)) {
      log('Web Serial not supported. Use Chrome/Edge desktop.', '!');
      return;
    }
    // Ask user to choose a port (HC-05 or Arduino USB)
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: parseInt(baudSel.value, 10) });

    // Writer
    writer = port.writable.getWriter();

    // Reader loop
    reading = true;
    readLoop().catch(e => {
      log('Read loop error: ' + e.message, '!');
    });

    setConnectedUI(true);
    log(`Connected @ ${baudSel.value} baud`, '✓');
  } catch (e) {
    log('Connect error: ' + e.message, '!');
    await disconnect();
  }
}

async function disconnect() {
  try {
    reading = false;
    if (reader) {
      try { await reader.cancel(); } catch {}
      reader.releaseLock();
      reader = null;
    }
    if (writer) {
      writer.releaseLock();
      writer = null;
    }
    if (port) {
      await port.close();
      port = null;
    }
  } catch (e) {
    log('Disconnect error: ' + e.message, '!');
  } finally {
    setConnectedUI(false);
    log('Disconnected', '⏏');
  }
}

async function readLoop() {
  const textDecoder = new TextDecoder();
  reader = port.readable.getReader();
  while (reading) {
    const { value, done } = await reader.read();
    if (done) break;
    if (value) {
      const chunk = textDecoder.decode(value);
      // Show each chunk as it arrives
      log(chunk, '←');
    }
  }
}

async function sendLine(text) {
  if (!writer) { log('Not connected', '!'); return; }
  const ending = lineSel.value;
  const payload = (text ?? '').toString() + (ending || '');
  try {
    await writer.write(new TextEncoder().encode(payload));
    log(payload.replace(/\r/g,'\\r').replace(/\n/g,'\\n'));
  } catch (e) {
    log('Write error: ' + e.message, '!');
  }
}

function bindUI() {
  btnConnect.addEventListener('click', connect);
  btnDisconnect.addEventListener('click', disconnect);

  document.querySelectorAll('[data-cmd]').forEach(b => {
    b.addEventListener('click', () => sendLine(b.getAttribute('data-cmd')));
  });

  el('btnOpen').addEventListener('click', () => {
    const v = parseInt(el('valveNum').value || '0', 10);
    if (v > 0) sendLine('open ' + v);
  });
  el('btnClose').addEventListener('click', () => {
    const v = parseInt(el('valveNum').value || '0', 10);
    if (v > 0) sendLine('close ' + v);
  });
  el('btnAP').addEventListener('click', async () => {
    const goOpen = confirm('Open AP (OK) or Close AP (Cancel)?');
    await sendLine((goOpen ? 'open ' : 'close ') + '99');
  });
  el('btnSend').addEventListener('click', () => {
    const c = el('cmd').value;
    if (c.trim().length) sendLine(c);
  });

  // Log helpers
  el('btnClear').addEventListener('click', () => { logBuffer = ""; logBox.textContent = ""; });
  el('btnCopy').addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(logBuffer); } catch {}
  });
  el('btnDownload').addEventListener('click', () => {
    const blob = new Blob([logBuffer], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `controller-log-${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Handle cable/BT unplug events
  if ('serial' in navigator) {
    navigator.serial.addEventListener('disconnect', async (e) => {
      if (port && e.target === port) {
        log('Port disconnected', '!');
        await disconnect();
      }
    });
    navigator.serial.addEventListener('connect', () => {
      log('Port connected (available to open)', 'i');
    });
  }

  // Initial state
  setConnectedUI(false);
}

bindUI();
</script>
</body>
</html>
