<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dialyzer Valve Controller</title>
<style>
  : root{
    --bg: #0f1115; --card:#151922; --muted:#a5adcb; --text:#e6eaf2; --accent:#7aa2f7; --ok:#3ccf91; --warn:#ffcc66; --err:#ff6b6b; --line:#222636;
    --btn:#1b2030; --btn-hover:#232a3c; --chip:#1a2130;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 14px;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f8fb; --card:#ffffff; --muted:#54607a; --text:#0b1020; --accent:#2f6bff; --ok:#0e9f6e; --warn:#b98900; --err:#c03c3c; --line:#e7e9f0; --btn:#eef2fb; --btn-hover:#e3e8f7; --chip:#eef2fb; }
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  }
  .wrap{ max-width:1200px; margin:32px auto; padding:0 20px; }
  /* Header */
  .bar{
    display:flex; align-items:center; gap:16px; background:var(--card); padding:14px 16px; border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
  }
  .title{ font-size:18px; font-weight:700; letter-spacing:.2px; display:flex; align-items:center; gap:10px }
  .title svg{ width:20px; height:20px; }
  .sp{ flex:1 }
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:var(--chip); border:1px solid var(--line); color:var(--muted);
  }
  .dot{ width:8px; height:8px; border-radius:50%; background:#ff6b6b; box-shadow:0 0 0 0 rgba(255,107,107,.6); animation:pulse 2s infinite; }
  .dot.ok{ background:var(--ok); box-shadow:0 0 0 0 rgba(60,207,145,.5) }
  @keyframes pulse {
    0% { box-shadow:0 0 0 0 rgba(255,107,107,.6) }
    70%{ box-shadow:0 0 0 10px rgba(255,107,107,0) }
    100%{ box-shadow:0 0 0 0 rgba(255,107,107,0) }
  }
  .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center }
  select,input,button{
    background:var(--btn); color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; outline:none;
  }
  button{ cursor:pointer; transition:all .15s ease }
  button:hover{ background:var(--btn-hover) }
  .btn-primary{ background:linear-gradient(180deg, var(--accent), #4f7ffb); border:none; color:#fff; font-weight:600 }
  .btn-ghost{ background:transparent; border:1px dashed var(--line); color:var(--muted) }
  .btn-danger{ background:linear-gradient(180deg, #ff7c7c, #e55757); border:none; color:#fff; font-weight:600 }
  /* Grid cards */
  .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:16px; margin-top:18px }
  @media (max-width:1100px){ .grid{ grid-template-columns:repeat(6,1fr) } }
  @media (max-width:700px){ .grid{ grid-template-columns:repeat(1,1fr) } }
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);
  }
  .card h3{ margin:0 0 10px; font-size:16px; letter-spacing:.2px }
  .muted{ color:var(--muted) }
  /* Buttons grid */
  .btns{ display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px }
  .chip{
    display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:999px; background:var(--chip); border:1px solid var(--line); color:var(--muted); font-size:12px;
  }
  .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:var(--bg); border:1px solid var(--line); padding:2px 6px; border-radius:6px }
  /* Log */
  #log{
    background: #0b0e14; color:#d2e1ff; border:1px solid var(--line); border-radius:12px; min-height:260px; max-height:360px; overflow:auto; padding:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12.5px;
  }
  .toolbar{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-bottom:10px }
  /* Toasts */
  .toasts{ position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px; z-index:99 }
  .toast{ background:var(--card); border:1px solid var(--line); border-left:4px solid var(--accent); color:var(--text); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); min-width:240px }
  .toast.ok{ border-left-color:var(--ok) } .toast.err{ border-left-color:var(--err) } .toast.warn{ border-left-color:var(--warn) }
  /* Footer */
  .foot{ display:flex; align-items:center; justify-content:space-between; color:var(--muted); margin-top:12px; font-size:12px }
  .link{ color:var(--accent); text-decoration:none }
  .input-grow{ flex:1; min-width:220px }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Top bar -->
    <div class="bar">
      <div class="title">
        <!-- inline logo -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2l7 4v6c0 5-3.5 7.5-7 10-3.5-2.5-7-5-7-10V6l7-4z" stroke-width="1.5"/></svg>
        Dialyzer Valve Controller
        <span class="chip">Web Serial</span>
      </div>
      <div class="sp"></div>
      <div class="row">
        <label class="muted">Baud
          <select id="baud">
            <option value="9600" selected>9600 (HC‚Äë05)</option>
            <option value="115200">115200 (Arduino USB)</option>
            <option value="38400">38400 (AT mode)</option>
            <option value="57600">57600</option>
            <option value="19200">19200</option>
          </select>
        </label>
        <label class="muted">Line ending
          <select id="lineEnding">
            <option value="\n" selected>\n</option>
            <option value="\r\n">\r\n</option>
            <option value="">None</option>
          </select>
        </label>
      </div>
      <span id="statusPill" class="pill"><span class="dot" id="dot"></span><span id="statusTxt">Disconnected</span></span>
      <button id="btnConnect" class="btn-primary">üîå Connect</button>
      <button id="btnDisconnect" class="btn-danger" disabled>‚èè Disconnect</button>
    </div>

    <div class="grid">
      <!-- Process buttons -->
      <div class="card" style="grid-column:span 6;">
        <h3>Quick Actions</h3>
        <div class="btns">
          <button class="btn-primary" data-cmd="1">1 ‚Ä¢ Affusion</button>
          <button class="btn-primary" data-cmd="2">2 ‚Ä¢ Cleaning</button>
          <button class="btn-primary" data-cmd="3">3 ‚Ä¢ Rinse</button>
          <button class="btn-primary" data-cmd="4">4 ‚Ä¢ Volume Test</button>
          <button data-cmd="5">5 ‚Ä¢ Manual Mode</button>
          <button data-cmd="6">6 ‚Ä¢ Status</button>
          <button class="btn-danger" data-cmd="7">7 ‚Ä¢ Stop / Close All</button>
          <button data-cmd="status">Status (text)</button>
          <button data-cmd="closeall">Close All (text)</button>
        </div>
        <div class="foot"><span class="muted">Tip: close Arduino Serial Monitor before connecting.</span><span class="muted">Shortcut: <span class="kbd">/</span> to focus command</span></div>
      </div>

      <!-- Valve control -->
      <div class="card" style="grid-column:span 6;">
        <h3>Valve Controls</h3>
        <div class="row" style="margin-bottom:10px">
          <input id="valveNum" class="input-grow" type="number" placeholder="Valve # (1..21 or 99 for AP)" min="1" max="99" />
          <button id="btnOpen">Open</button>
          <button id="btnClose">Close</button>
          <button class="btn-ghost" id="btnAP">AP Toggle</button>
        </div>
        <div class="muted">Preset grid</div>
        <div class="btns" id="valveGrid"></div>
      </div>

      <!-- Command -->
      <div class="card" style="grid-column:span 6;">
        <h3>Command Palette</h3>
        <div class="row">
          <input id="cmd" class="input-grow" placeholder='Type commands: open 6, close 6, AFFUSION, RINSE, VOLUME, status' />
          <button id="btnSend" class="btn-primary">Send ‚èé</button>
        </div>
        <div class="foot"><span class="muted">Ends with: <span id="endingEcho" class="kbd">\n</span></span><a class="link" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API" target="_blank" rel="noreferrer">About Web Serial ‚Üó</a></div>
      </div>

      <!-- Log -->
      <div class="card" style="grid-column:span 6;">
        <h3>Log</h3>
        <div class="toolbar">
          <button id="btnCopy">Copy</button>
          <button id="btnClear" class="btn-ghost">Clear</button>
        </div>
        <div id="log"></div>
      </div>
    </div>
    <div class="toasts" id="toasts"></div>
  </div>

<script>
let port, reader, writer, isConnected = false, keepReading = false;
const $ = sel => document.querySelector(sel);
const logBox = $('#log');
function log(msg, dir="‚Üí"){ const t = new Date().toLocaleTimeString(); logBox.textContent += `[${t}] ${dir} ${msg}\n`; logBox.scrollTop = logBox.scrollHeight; }
function toast(txt, type=""){ const box = $('#toasts'); const el = document.createElement('div'); el.className = `toast ${type}`; el.textContent = txt; box.appendChild(el); setTimeout(()=>{ el.style.opacity=.0; setTimeout(()=>el.remove(),250)}, 2500); }
function setStatus(connected, txt){
  isConnected = connected;
  $('#statusTxt').textContent = txt || (connected ? "Connected" : "Disconnected");
  const dot = $('#dot');
  dot.classList.toggle('ok', connected);
  $('#btnDisconnect').disabled = !connected;
  $('#btnConnect').disabled = connected;
}

async function connect(){
  try{
    if(!('serial' in navigator)){ toast("Web Serial not supported. Use Chrome/Edge desktop.", "err"); return; }
    const baud = parseInt($('#baud').value, 10);
    port = await navigator.serial.requestPort(); // user picks Arduino USB or HC‚Äë05 COM
    await port.open({ baudRate: baud });
    writer = port.writable.getWriter();
    keepReading = true;
    readLoop();
    setStatus(true, `Connected @ ${baud}`);
    toast("Connected ‚úì", "ok");
    log(`Connected @ ${baud}`, "‚úì");
  }catch(e){
    toast("Connect error: " + e.message, "err");
    log("Connect error: " + e.message, "!");
  }
}
async function disconnect(){
  try{
    keepReading = false;
    if(reader){ await reader.cancel(); reader.releaseLock(); reader = null; }
    if(writer){ writer.releaseLock(); writer = null; }
    if(port){ await port.close(); port = null; }
    setStatus(false, "Disconnected");
    toast("Disconnected", "warn");
    log("Disconnected", "‚èè");
  }catch(e){ toast("Disconnect error: " + e.message, "err"); }
}
async function readLoop(){
  try{
    reader = port.readable.getReader();
    const dec = new TextDecoder();
    while(keepReading){
      const { value, done } = await reader.read();
      if(done) break;
      if(value) log(dec.decode(value), "‚Üê");
    }
  }catch(e){ log("Read error: " + e.message, "!"); }
  finally{ if(reader){ reader.releaseLock(); reader = null; } }
}
async function sendLine(text){
  if(!writer){ toast("Not connected", "warn"); return; }
  const ending = $('#lineEnding').value;
  const payload = (text ?? "").toString() + (ending || "");
  try{
    await writer.write(new TextEncoder().encode(payload));
    log(payload.replace(/\r/g,"\\r").replace(/\n/g,"\\n"));
  }catch(e){
    toast("Write error: " + e.message, "err");
    log("Write error: " + e.message, "!");
  }
}
$('#btnConnect').addEventListener('click', connect);
$('#btnDisconnect').addEventListener('click', disconnect);
$('#btnSend').addEventListener('click', ()=> sendLine($('#cmd').value));
$('#cmd').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#btnSend').click(); } });
$('#lineEnding').addEventListener('change', e=> $('#endingEcho').textContent = e.target.value || 'none');
$('#baud').addEventListener('change', ()=> toast(`Baud set to ${$('#baud').value}`,''));
$('#btnCopy').addEventListener('click', async ()=>{
  await navigator.clipboard.writeText(logBox.textContent || "");
  toast("Log copied ‚úì","ok");
});
$('#btnClear').addEventListener('click', ()=>{ logBox.textContent=""; });

document.querySelectorAll('[data-cmd]').forEach(btn=>{
  btn.addEventListener('click', ()=> sendLine(btn.getAttribute('data-cmd')));
});

$('#btnOpen').addEventListener('click', ()=>{
  const v = parseInt($('#valveNum').value||"0",10);
  if(v>0) sendLine("open "+v); else toast("Enter a valve number","warn");
});
$('#btnClose').addEventListener('click', ()=>{
  const v = parseInt($('#valveNum').value||"0",10);
  if(v>0) sendLine("close "+v); else toast("Enter a valve number","warn");
});
$('#btnAP').addEventListener('click', ()=>{
  const open = confirm("Open AP (OK) or Close AP (Cancel)?");
  sendLine((open ? "open " : "close ") + "99");
});

// Build a quick valve button grid (1..21 + AP 99)
(function buildValveGrid(){
  const g = $('#valveGrid');
  for(let i=1;i<=21;i++){
    const b = document.createElement('button'); b.textContent = `Open ${i}`; b.addEventListener('click', ()=> sendLine('open '+i));
    g.appendChild(b);
  }
  const ap = document.createElement('button'); ap.textContent = 'Open AP (99)'; ap.className='btn-ghost'; ap.addEventListener('click',()=>sendLine('open 99'));
  g.appendChild(ap);
})();

// UX niceties
document.addEventListener('keydown', e=>{
  // '/' to focus command
  if(e.key==='/' && e.target.tagName!=='INPUT' && e.target.tagName!=='TEXTAREA'){ e.preventDefault(); $('#cmd').focus(); }
  // Ctrl/Cmd+K to connect/disconnect
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); isConnected?$('#btnDisconnect').click():$('#btnConnect').click(); }
});

// Browser support hint
if(!('serial' in navigator)){
  setStatus(false, "Unsupported browser");
  toast("Web Serial not supported. Use Chrome/Edge desktop.", "err");
}
</script>
</body>
</html>
